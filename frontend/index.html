<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>쿠폰 파일 업로더</title>
</head>
<body>
    <h1>파일 업로드</h1>
    <input type="file" id="fileInput">
    <button onclick="uploadFile()">업로드</button>

    <hr>
    <h2>결과</h2>
    <div id="result"></div>
    <div id="download-section" style="display:none;">
        <p>파일 ID: <span id="fileId"></span></p>
        <button onclick="getDownloadUrl()">다운로드 URL 받기</button>
        <div id="download-link"></div>
    </div>

    <script>
        // fileId를 저장할 전역 변수
        let currentFileId = null;

        // 파일 업로드 함수
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            if (fileInput.files.length === 0) {
                alert('파일을 선택해주세요.');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const response = await fetch('/files/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('업로드 실패: ' + response.statusText);
                }

                const result = await response.json();

                if (result.isSuccess) {
                    const data = result.data; 
                    
                    currentFileId = data.fileId;

                    document.getElementById('result').innerText = data.message;
                    document.getElementById('fileId').innerText = currentFileId;
                    document.getElementById('download-section').style.display = 'block';
                } else {
                    // 서버가 isSuccess: false로 응답한 경우
                    throw new Error(result.message);
                }

            } catch (error) {
                document.getElementById('result').innerText = '오류: ' + error.message;
            }
        }

        // 다운로드 URL 요청 함수
        async function getDownloadUrl() {
            if (!currentFileId) {
                alert('파일 ID가 없습니다. 먼저 파일을 업로드해주세요.');
                return;
            }

            try {
                const response = await fetch(`/files/download/${currentFileId}`);
                if (!response.ok) {
                    throw new Error('다운로드 URL 요청 실패');
                }
                
                const result = await response.json();
                
                if (result.isSuccess) {
                    const data = result.data; 
                    
                    const link = document.createElement('a');
                    link.href = data.downloadUrl; 
                    link.innerText = `다운로드 (${data.fileName})`;
                    link.target = '_blank';

                    const downloadDiv = document.getElementById('download-link');
                    downloadDiv.innerHTML = '';
                    downloadDiv.appendChild(link);
                } else {
                    throw new Error(result.message);
                }
                
            } catch (error) {
                document.getElementById('download-link').innerText = '오류: ' + error.message;
            }
        }
    </script>


</body>
</html>